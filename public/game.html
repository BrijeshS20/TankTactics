<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <title>Tank Tactics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.1.1/cerulean/bootstrap.min.css">
    <style>
        #homelink {
            color: white;
            text-decoration: none;
        }

        #help {
            display: none;
            color: white;
        }

        #helplist {
            list-style-type: none;
        }

        #game {
            display: none;
        }

        div#game > div#lobbies.col-2.border-end > div.row > a {
            text-decoration: none;
            color: white;
        }
        .dropdown-menu {
            background-color: transparent;
            color: white;
        }
        button {
            background-color: rgb(52,58,64);
            color: white;
            margin-right: 10px;
        }
    </style>

</head>

<body class="d-flex h-100 text-center text-white bg-dark container-fluid">
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
        <header class="mb-auto">
            <div>
                <h3 class="float-md-start mb-0">
                    <a href="#home" id="homelink">
                        Tank Tactics
                    </a>
                </h3>
                <nav class="nav nav-masthead justify-content-center float-md-end">
                    <a class="nav-link active" aria-current="page" href="https://discord.com/app"
                       target="_blank">Open Discord</a>
                    <a class="nav-link" href="#help" id="helplink">Help</a>
                    <a class="nav-link" href="https://discord.com/api/oauth2/authorize?client_id=893072412558655558&permissions=2048&scope=bot%20applications.commands"
                       target="_blank">Invite the bot</a>
                </nav>
            </div>
            <br><br>
            <hr>
        </header>
        <main class="px-3">
            <div id="home">
                <h1>Tank Tactics</h1>
                <p class="lead">
                    <a class="btn btn-lg btn-secondary fw-bold border-white bg-white" href="#game"
                       id="gamelink">Play Game</a>
                </p>
            </div>
            <div id="help">
                <h1>Help</h1>
                <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            Hello I will teach you how to play this game. First U must   <a class="nav-link" href="https://discord.com/api/oauth2/authorize?client_id=893072412558655558&permissions=2048&scope=bot%20applications.commands" target="_blank">Invite the bot</a>.<br />
                            Then type !game in the chat.<br />
                            Then navigate here and click on the lobby.
                            <br />
                        </div>
                        <div class="carousel-item">
                            You will be given a action point randomly throughout the day.<br />
                            You can use it to move around and increase the accuracy for your tank.
                            <br />
                            If you are horizontaly or verticaly in the same line as another tank u can attack it.
                            <br /> The goal of the Game is to be the last man alive.
                            <br />
                            You can give anyone your action points.
                            <br />

                            Dont worry if you die then you can give the alive people your action points when you get them. This makes the dead players the strongest players.<br />
                            So in order to win you must talk to other plkayer form alliances and in the end you may have to betray them.
                        </div>
                        <div class="carousel-item">
                            In order to win this game you must team up talk to as many people as possible make alliances as you will not be able to win alone.
                            <br />
                            If you face any issues, contact one of the following staff at discord:
                            <ul id="helplist">
                                <li>deepparag#6330</li>
                                <li>ThunderX#6969</li>
                                <li>DaWise_Weirdo#1120</li>
                                <li>multiii ;>#7676</li>
                            </ul>
                            <br />
                            Report bugs and give us your Suggestion here:-https://forms.gle/FenEgrA2m5mbEtx96.
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

            </div>
            <div id="game" class="row">
                <!-- Alerts to be displayed here -->
                <div id="alertspawn"></div>
                <!--Menu Showing List Of Active Lobbies-->
                <div id="lobbies" class="col-2 border-end">

                </div>
                <!-- The Canvas for the Actual Game -->
                <div id="gameview" class="col-8 border-end">
                    <img style="width:100%; height:auto;" id="game-image" />
                </div>
                <!--Dropdown button with options of attacking and giving points-->
                <div id="playerinterface" class="col-2">
                </div>
            </div>
        </main>
        <footer class="mt-auto text-white-50">
            <hr>
            <p>
                A game which runs on both the communication platform discord and on website. It's idle, real time and co-op.<br> This is war based statergy game in which you have to co-operate with players to win.
                <br>
                A game made by a squad of friends.
            </p>
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/mustache@latest"></script>
    <script id="template" type="x-tmpl-mustache">
        <div class="carousel-item"  id="PlayerData">
        <div style="width:100%;height:auto; min-height:20px;background-color:{{color.color}}"> </div>
         <span class="justify-content-center" style="text-align:center">{{name}}<br>Action points: {{actionPoints}}<br> Health: {{health}}  <br> accuracy: {{accuracy}}%<span>
        </div>
    </script>

    <script id="lobby" type="x-tmpl-mustache">
            <button class="btn btn-outline-light btn-sm " onclick="channelId = '{{channelId}}';RenderMap();"> {{channelName}} in {{serverName}}</button>
    </script>


    <script id="attackTemplate" type="x-tmpl-mustache">
            <button class="btn btn-outline-light btn-sm "  onclick="move({{id}},'attack')">{{name}}</button>

    </script>
    <script id="stealTemplate" type="x-tmpl-mustache">
             <button class="btn btn-outline-light btn-sm " onclick="move({{id}},'steal')">{{name}}</button>
    </script>

    <script id="giveTemplate" type="x-tmpl-mustache">
             <button class="btn btn-outline-light btn-sm " onclick="move({{id}},'give')">{{name}}</button>
    </script>
    <script>
        let channelId = 0;
        let alertspawn = document.querySelector("#alertspawn");
        // Helper Functions:
        function getUrlVars() {
            let vars = {};
            let parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m, key, value) => {
                vars[key] = value;
            });
            return vars;
        }
        function notify(message) {
            alertspawn.innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            `;
        }
        function move(id, type) {
            $.get('https://tanktactics.uc.r.appspot.com/move', { "channelId": channelId, "userId": getUrlVars()['userId'].split('#')[0], "move": type, "id": id }, resp => { notify(resp.message); RenderMap(); });
        }
        //Draw RenderMap
        function RenderMap() {
            if (channelId != 0) {
                $.get('https://tanktactics.uc.r.appspot.com/data', { "channelId": channelId }, resp => {
                    console.log(resp);
                    let game = resp;
                    const width = game.boardSize * 2 * 10 + 10;
                    const height = game.boardSize * 2 * 10 + 10;

                    const canvas = document.createElement('canvas');
                    canvas.setAttribute("width", width);
                    canvas.setAttribute("height", height);
                    const context = canvas.getContext('2d');
                    context.fillStyle = '#343a40';
                    context.fillRect(0, 0, width, height)

                    context.fillStyle = '#a39c93';
                    for (var x = 0; x < game.boardSize; x++) {

                        for (var y = 0; y < game.boardSize; y++) {
                            context.fillRect(x * 20 + 10, y * 20 + 10, 10, 10);
                        }

                    }
                    var rendered = "";
                    var attack = "";
                    var give = "";
                    var steal = "";
                    game.users.forEach((user) => {
                        rendered += Mustache.render(document.getElementById('template').innerHTML, user);
                        if (user.health > 0) {
                            context.fillStyle = user.color.color;
                            context.fillRect(user.x * 20 - 1.5, user.y * 20 - 1.5, 13, 13);
                        }
                        attack += Mustache.render(document.getElementById('attackTemplate').innerHTML, user);
                        give += Mustache.render(document.getElementById('giveTemplate').innerHTML, user);
                        steal += Mustache.render(document.getElementById('stealTemplate').innerHTML, user);
                    });
                    document.getElementById('stealMenu').innerHTML = steal;
                    document.getElementById('attackMenu').innerHTML = attack;
                    document.getElementById('giveMenu').innerHTML = give;
                    document.getElementById('playerData').innerHTML = rendered;
                    document.getElementById('PlayerData').classList.add('active');
                    document.getElementById('game-image').src = canvas.toDataURL();

                });

            }
        }


        document.addEventListener('DOMContentLoaded', () => {

            let help = document.querySelector("#help");
            let home = document.querySelector("#home");
            let game = document.querySelector("#game");

            let lobbies = document.querySelector("#lobbies");
            let gameview = document.querySelector("#gameview");
            let playerInterface = document.querySelector("#playerinterface");

            let homelink = document.querySelector('#homelink');
            let helplink = document.querySelector('#helplink');
            let gamelink = document.querySelector('#gamelink');



            playerInterface.innerHTML = `
                                                    <span class=""> <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                                          <div class="carousel-inner" id="playerData">
                                          </div>
                                          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                            <span class="visually-hidden">Previous</span>
                                          </button>
                                          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                            <span class="visually-hidden">Next</span>
                                          </button>
                                         </div></span>
                                                    <div class="dropdown">
                                                        <div class="btn-group dropstart" role="group">
                                                            <button class="btn btn-outline-light btn-sm dropdown-toggle" id="give" data-toggle="dropdown" data-bs-toggle="dropdown"
                                                            aria-expanded="false">Give Action Points</button>
                                                            <ul class="dropdown-menu" aria-labelledby="give" id="giveMenu">
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <div class="dropdown">
                                                        <div class="btn-group dropstart" role="group">
                                                            <button class="btn btn-outline-light btn-sm dropdown-toggle" id="attack" data-toggle="dropdown" data-bs-toggle="dropdown"
                                                             aria-expanded="false">Attack Opponents</button>
                                                            <ul class="dropdown-menu" aria-labelledby="attack" id="attackMenu">

                                                            </ul>
                                                        </div>
                                                    </div>
                                                      <div class="dropdown">
                                                        <div class="btn-group dropstart" role="group">
                                                            <button class="btn btn-outline-light btn-sm dropdown-toggle" id="give" data-toggle="dropdown" data-bs-toggle="dropdown"
                                                            aria-expanded="false">Steal Action Points</button>
                                                            <ul class="dropdown-menu" aria-labelledby="give" id="stealMenu">
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button class="btn btn-outline-light" onclick="move(99,'left');">Left</button>
                                                        <button class="btn btn-outline-light onclick="move(99,'up');" >Up</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button class="btn btn-outline-light"onclick="move(99,'right');">Right</button>
                                                        <button class="btn btn-outline-light"onclick="move(99,'down');">Down</button>
                                                        <br>

                                                    </div>
      <button class="btn btn-outline-light"onclick="move(99,'upgrade');" >Upgrade</button>
<br>
     <button class="btn btn-outline-light"onclick="move(99,'heal');" >Heal</button>
                                                `;





            // Single Page App Helper Functions:
            function showHome() {
                game.style.display = "none";
                help.style.display = "none";
                home.style.display = "block";
            }

            function showHelp() {
                game.style.display = "none";
                home.style.display = "none";
                help.style.display = "block";
            }

            function showGame() {


                // Make the list of lobbies on the left

                $.get('https://tanktactics.uc.r.appspot.com/games', { "userId": getUrlVars()['userId'].split('#')[0] }, resp => {
                    let lobbylist = "";
                    var lobbyTemplate = document.getElementById('lobby');
                    console.log(resp);
                    if (resp.length > 0) {
                        resp.forEach(lobby => {
                            lobbylist += Mustache.render(lobbyTemplate.innerHTML, lobby);
                        });
                        lobbies.innerHTML = lobbylist;
                        // Make the Game Page visible
                        home.style.display = "none";
                        help.style.display = "none";
                        game.style.display = "flex";
                    } else {
                        alert('Please join a lobby. If you dont know how to see help!!');
                    }
                });


                // Give/Take Action Points Dropdown.
            }

            homelink.addEventListener('click', showHome);
            helplink.addEventListener('click', showHelp);
            gamelink.addEventListener('click', () => {
                if (!(getUrlVars().hasOwnProperty('userId')) || getUrlVars()['userId'] === '') {
                    showHome();
                    gamelink.href = "https://discord.com/api/oauth2/authorize?client_id=893072412558655558&redirect_uri=https%3A%2F%2Ftanktactics.uc.r.appspot.com%2Fauthorize&response_type=code&scope=identify%20guilds";
                } else {
                    showHome();
                    gamelink.href = "#game";
                    showGame();
                }
            });


            setInterval(RenderMap, 1000 * 60);
        });
    </script>


</body>

</html>